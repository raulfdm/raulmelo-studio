---
import { Image as AstroImage } from 'astro:assets';
import { imgUrlFor } from '@raulmelo/core/utils';

import { sanityClient } from '@/infrastructure/sanity/client';

type Props = {
  node: {
    caption: string;
    customWidth?: number;
    alt?: string;
    image: {
      url: string;
      width: number;
      height: number;
    };
  };
};

const {
  node: { image, caption, customWidth, alt },
} = Astro.props;

const { url, width, height } = imgUrlFor(sanityClient, image);

const finalWidth = customWidth || width;
const finalHeight = customWidth
  ? calculateCustomHeight(height, width, finalWidth)
  : height;

function calculateCustomHeight(
  height: number,
  width: number,
  customWidth: number,
): number {
  const aspectRatio = height / width;
  const customHeight = aspectRatio * customWidth;
  return customHeight;
}
---

<figure class="flex items-center flex-col">
  <AstroImage
    src={url}
    alt={alt ?? caption}
    width={finalWidth}
    height={finalHeight}
  />
  {
    caption ? (
      <figcaption class="mt-2 text-center lg:mt-4">{caption}</figcaption>
    ) : null
  }
</figure>
